generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String     @id @default(uuid())
  phone     String     @unique
  role      Role
  status    UserStatus @default(ACTIVE)
  fullName  String?
  email     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  adminLogs  AuditLog[] @relation("AdminLogs")
  driver     Driver?
  riderTrips Trip[]     @relation("RiderTrips")

  isMerchant      Boolean @default(false)
  merchantTrusted Boolean @default(false)
}

model OtpSession {
  id         String    @id @default(uuid())
  phone      String
  otpHash    String
  expiresAt  DateTime
  verifiedAt DateTime?
  attempts   Int       @default(0)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())

  @@index([phone])
}

model Driver {
  id           String       @id @default(uuid())
  userId       String       @unique
  driverType   DriverType
  kycStatus    KycStatus    @default(PENDING)
  availability Availability @default(OFFLINE)
  city         City         @default(ABUJA)
  approvedAt   DateTime?
  rejectedAt   DateTime?
  kycNote      String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user      User             @relation(fields: [userId], references: [id])
  documents DriverDocument[]
  location  DriverLocation?
  wallet    DriverWallet?
  payouts   Payout[]
  trips     Trip[]           @relation("DriverTrips")
  vehicle   Vehicle?
}

model Vehicle {
  id          String      @id @default(uuid())
  driverId    String      @unique
  vehicleType VehicleType
  make        String?
  model       String?
  color       String?
  year        Int?
  plateNumber String?
  createdAt   DateTime    @default(now())

  driver Driver @relation(fields: [driverId], references: [id])
}

model DriverDocument {
  id         String    @id @default(uuid())
  driverId   String
  docType    DocType
  fileUrl    String
  status     DocStatus @default(UPLOADED)
  reviewNote String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  driver Driver @relation(fields: [driverId], references: [id])

  @@index([driverId, docType])
}

model DriverLocation {
  driverId   String   @id
  lat        Float
  lng        Float
  heading    Int?
  accuracyM  Float?
  lastSeenAt DateTime @default(now())

  driver Driver @relation(fields: [driverId], references: [id])

  @@index([lastSeenAt])
}

model FarePolicy {
  id          String      @id @default(uuid())
  city        City        @default(ABUJA)
  serviceType ServiceType
  currency    Currency    @default(NGN)
  baseFare    Int
  perKmFare   Int
  perMinFare  Int
  bookingFee  Int
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([city, serviceType, isActive])
}

model Trip {
  id          String      @id @default(uuid())
  serviceType ServiceType
  city        City        @default(ABUJA)

  riderId  String
  driverId String?

  status       TripStatus   @default(REQUESTED)
  cancelledBy  CancelledBy?
  cancelReason String?

  pickupAddress  String
  pickupLat      Float
  pickupLng      Float
  dropoffAddress String
  dropoffLat     Float
  dropoffLng     Float

  distanceKmEst  Float?
  durationMinEst Float?

  requestedAt DateTime  @default(now())
  matchedAt   DateTime?
  acceptedAt  DateTime?
  arrivedAt   DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentMode        PaymentMode      @default(PAY_ON_DROPOFF)
  commitmentStatus   CommitmentStatus @default(PENDING)
  commitmentAmount   Int?
  commitmentWaivedAt DateTime?
  commitmentWaivedBy String?
  commitmentReason   String?

  payment  Payment?
  fare     TripFare?
  delivery TripDelivery?

  driver Driver? @relation("DriverTrips", fields: [driverId], references: [id])
  rider  User    @relation("RiderTrips", fields: [riderId], references: [id])

  @@index([status, serviceType, city])
  @@index([riderId, requestedAt])
  @@index([driverId, status])
}

model TripDelivery {
  id     String @id @default(uuid())
  tripId String @unique

  itemDescription String
  recipientName   String
  recipientPhone  String
  noteToCourier   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

model TripFare {
  tripId          String   @id
  currency        Currency @default(NGN)
  baseFare        Int
  perKmFare       Int
  perMinFare      Int
  bookingFee      Int
  discount        Int      @default(0)
  totalAmount     Int
  platformEarning Int
  driverEarning   Int
  distanceKm      Float?
  durationMin     Float?
  createdAt       DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id])
}

model Payment {
  id               String          @id @default(uuid())
  tripId           String          @unique
  provider         PaymentProvider @default(PAYSTACK)
  method           PaymentMethod   @default(TRANSFER)
  status           PaymentStatus   @default(PENDING)
  amount           Int
  currency         Currency        @default(NGN)
  reference        String          @unique
  authorizationUrl String?
  verifiedAt       DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  trip          Trip                   @relation(fields: [tripId], references: [id])
  webhookEvents PaystackWebhookEvent[]
}

model PaystackWebhookEvent {
  id         String            @id @default(uuid())
  paymentId  String?
  eventType  PaystackEventType @default(UNKNOWN)
  eventId    String?           @unique
  reference  String?
  payload    Json
  receivedAt DateTime          @default(now())

  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([reference])
}

model DriverWallet {
  driverId  String   @id
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  driver Driver              @relation(fields: [driverId], references: [id])
  txs    WalletTransaction[]
}

model WalletTransaction {
  id        String         @id @default(uuid())
  driverId  String
  tripId    String?
  type      WalletTxType
  reason    WalletTxReason
  amount    Int
  note      String?
  createdAt DateTime       @default(now())

  wallet DriverWallet @relation(fields: [driverId], references: [driverId])

  @@index([driverId, createdAt])
}

model Payout {
  id                  String         @id @default(uuid())
  driverId            String
  schedule            PayoutSchedule
  amount              Int
  status              PayoutStatus   @default(PENDING)
  paystackTransferRef String?
  createdAt           DateTime       @default(now())
  paidAt              DateTime?

  driver Driver @relation(fields: [driverId], references: [id])

  @@index([driverId, schedule, status])
}

model AuditLog {
  id          String   @id @default(uuid())
  adminUserId String
  action      String
  entityType  String
  entityId    String
  metadata    Json?
  createdAt   DateTime @default(now())

  admin User @relation("AdminLogs", fields: [adminUserId], references: [id])

  @@index([adminUserId, createdAt])
}

enum CommitmentStatus {
  PENDING
  CONFIRMED
  WAIVED
}

enum PaymentMode {
  PAY_ON_DROPOFF
  PREPAID
}

enum Role {
  RIDER
  DRIVER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum DriverType {
  CAR_DRIVER
  BIKE_COURIER
}

enum VehicleType {
  CAR
  BIKE
}

enum KycStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum Availability {
  OFFLINE
  ONLINE
  ON_TRIP
}

enum City {
  ABUJA
}

enum ServiceType {
  CAR_RIDE
  BIKE_DELIVERY
}

enum TripStatus {
  REQUESTED
  MATCHED
  ACCEPTED
  ARRIVED
  STARTED
  COMPLETED
  CANCELLED
}

enum CancelledBy {
  RIDER
  DRIVER
  ADMIN
  SYSTEM
}

enum DocType {
  DRIVERS_LICENSE
  VEHICLE_PAPERS
  INSURANCE
  NIN
  OTHER
}

enum DocStatus {
  UPLOADED
  VERIFIED
  REJECTED
}

enum Currency {
  NGN
}

enum PaymentProvider {
  PAYSTACK
}

enum PaymentMethod {
  TRANSFER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaystackEventType {
  CHARGE_SUCCESS
  TRANSFER_SUCCESS
  TRANSFER_FAILED
  UNKNOWN
}

enum PayoutSchedule {
  DAILY
  WEEKLY
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum WalletTxType {
  CREDIT
  DEBIT
}

enum WalletTxReason {
  TRIP_EARNING
  ADJUSTMENT
  PAYOUT
}
